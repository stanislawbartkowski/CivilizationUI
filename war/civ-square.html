<dom-module id="civ-square">

<template>

<style>
    paper-button {
      text-transform: none;
   }

  :host {
    display: inline-block;
    /* border: ridge; */
    border: 0px none;
    border-color: DarkGray;
    background-size: 100% 100%;
    position : relative;
    float:left;
  }

  :host([Glowing]) {
    display: inline-block;
    border : 1px solid red;
    position : relative;
    border-radius: 20px;
  }

  :host([Village]) {
    background-color: #ffccb3;
  }

  :host([Hut]) {
    background-color: #ccffcc;
  }

  :host([Capital]) {
    background-image: url("images/cities/capital.svg");
    background-repeat: no-repeat;
    background-color: ForestGreen;
    background-size: 60%;
    background-position: top;
  }

  :host([Normal]) {
    background-image: url("images/cities/city.svg");
    background-repeat: no-repeat;
    background-color: ForestGreen;
    background-size: 60%;
    background-position: top;
  }


  :host([Forest]) {
    background-image: url("images/terrain/forest.svg");
    background-size: 60% 60%;
    background-repeat: no-repeat;
    background-color: ForestGreen;
    background-position: center;
  }

  :host([Water]) {
    background-image: url("images/terrain/water.svg");
    background-color: lightblue;
  }

  :host([Mountain]) {
    background-image: url("images/terrain/mountain.svg");
    background-color: DarkOliveGreen;
  }

  :host([Grassland]) {
    background-image: url("images/terrain/grassland.svg");
    background-color: DarkSeaGreen;
  }

  :host([Desert]) {
    background-image: url("images/terrain/desert.svg");
    background-color: LightGoldenRodYellow;
  }

 </style>

   <div style="width : {{boxwidth}}px; height : {{boxheight}}px; ">
     <img id="trade" hidden src="images/tokens/trade.svg"      style="z-index:1; position:absolute; bottom:0px; left:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="prod1" hidden src="images/tokens/production.svg" style="z-index:1; position:absolute; bottom:0px; left:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="prod2" hidden src="images/tokens/production.svg" style="z-index:1; position:absolute; bottom:0px; left:0; bottom:{{tokenheight}}px; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="iron" hidden src="images/resource/iron.svg"    title="{{localize('ironlabel')}}"  style="z-index:1; position:absolute; bottom:0px; right:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="wheat" hidden src="images/resource/wheat.svg"  title="{{localize('wheatlabel')}}"  style="z-index:1; position:absolute; bottom:0px; right:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="incense" hidden src="images/resource/incense.svg" title="{{localize('incenselabel')}}" style="z-index:1; position:absolute; bottom:0px; right:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="silk" hidden src="images/resource/silk.svg"  title="{{localize('silklabel')}}" style="z-index:1; position:absolute; bottom:0px; right:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="coin" hidden src="images/resource/coin.svg"  title="{{localize('silkcoin')}}" style="z-index:1; position:absolute; bottom:0px; right:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
     <img id="hut" hidden src="images/huts/hut.svg" title="{{localize('hutlabel')}}"   style="z-index:0; position:absolute; left:{{hutleft}}px; bottom:{{hutbottom}}px; width:{{hutwidth}}px; height:{{hutheight}}px;"/>
     <img id="village" hidden src="images/huts/village.svg" title="{{localize('villagelabel')}}" style="z-index:0; position:absolute; left:{{hutleft}}px; bottom:{{hutbottom}}px; width:{{hutwidth}}px; height:{{hutheight}}px;"/>

     <span id="attcity" style="display:none">
       <img id="prodcity" src="images/tokens/production.svg" style="z-index:1; position:absolute; bottom:0px; left:0; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
       <paper-badge id="prodcitynumber" for="prodcity" label="0">
       </paper-badge>

       <img id="defencecity" src="images/cities/shield.svg" style="z-index:1; position:absolute; bottom:0px; right:13px; width:{{tokenwidth}}px; height:{{tokenheight}}px;"/>
       <paper-badge id="defencecitynumber" for="defencecity" label="0">
       </paper-badge>
    </span>


     <span id="army1" style="z-index:2; position:absolute; display:none; width:50%; height:50%; top:{{armytop}}px; left:{{armyleft}}px">
       <s-svg fill="{{figurecolor1}}" src="images/figures/army.svg" ></s-svg>
     </span>
     <paper-badge hidden id="army1number" for="army1" label="5">
     </paper-badge>

     <span id="scout1" style="z-index:2; position:absolute; display:none; width:50%; height:50%; top:{{scouttop}}px; right:{{scoutright}}px">
      <s-svg fill="{{figurecolor1}}" src="images/figures/scout.svg"></s-svg>
     </span>
     <paper-badge hidden id="scout1number" for="scout1" label="5">
      </paper-badge>

     <span id="army2" style="z-index:2; position:absolute; display:none; width:50%; height:50%; top:{{armytop}}px; left:{{armyleft}}px">
       <s-svg fill="{{figurecolor2}}" src="images/figures/army.svg" ></s-svg>
     </span>
     <paper-badge hidden id="army2number" for="army2" label="5">
     </paper-badge>

     <span id="scout2" style="z-index:2; position:absolute; display:none; width:50%; height:50%; top:{{scouttop}}px; right:{{scoutright}}px">
      <s-svg fill="{{figurecolor2}}" src="images/figures/scout.svg"></s-svg>
     </span>
     <paper-badge hidden id="scout2number" for="scout2" label="5">
      </paper-badge>

   </div>


</template>

<script>

class CivSquare extends Polymer.CivData(Polymer.GestureEventListeners(Polymer.Element)) {

    constructor() {
        super();
        Polymer.Gestures.addListener(this, 'tap', () => this.handleClick());
    }

    static get is() {
        return 'civ-square';
        }

    _constructcommandquestion(command) {
        return this.localize("executecommandquestion","command",C.getcommanddecr(command))        
      }
          
    handleClick() {
        var res = C.getsquare(this.row,this.col)
        if (res.terrain == null) return
        var co = C.getcurrentcommand()
        if (C.emptyS(co)) return
        var i = C.getitemizedcommand()
        C.confexecutedialog(this._constructcommandquestion(co),co,this.row,this.col,null)
    }

    // Declare properties for the element's public API
    static get properties() {
      return {
          boxwidth: {
              type: Number,
              readOnly: true,
              value: 60
          },
        boxheight: {
            type: Number,
            readOnly: true,
            value: 45
          },
        tokenwidth  : {
            type: Number,
            readOnly: true,
            value: 16
        },
        tokenheight  : {
            type: Number,
            readOnly: true,
            value: 12
          },
        hutwidth  : {
              type: Number,
              readOnly: true,
              value: 45
          },
        hutheight  : {
              type: Number,
              readOnly: true,
              value: 45
            },
        hutbottom  : {
          type: Number,
          value: function() { return (this.boxheight-this.hutheight)/2 }
          },
        hutleft  : {
            type: Number,
            value: function() { return (this.boxwidth - this.hutwidth)/2 }
            },
        armytop : {
          type : Number,
          readOnly: true,
          value : 9
        },
        armyleft : {
          type : Number,
          readOnly: true,
          value : 2
        },
        scouttop : {
          type : Number,
          readOnly: true,
          value : 7
        },
        scoutright : {
          type : Number,
          readOnly: true,
          value : 2
        },

         figurecolor1 : {
           type: String,
           value: function() { return C.color1(); }
         },
         figurecolor2 : {
             type: String,
             value: function() { return C.color2(); }
         },
         terrains : {
           type : Array,
           readOnly: true,
           value : ["mountain","water","forest","grassland","desert", "capital", "normal","hut","village","glowing"]
         }
    }
    }

   _removearmy() {
     C.displayelem(this.$.army1, false)
     C.showeleme(this.$.army1number,false)
     C.displayelem(this.$.army1, false)
     C.showeleme(this.$.army1number,false)
     C.displayelem(this.$.army2, false)
     C.showeleme(this.$.army2number,false)
     C.displayelem(this.$.army2, false)
     C.showeleme(this.$.army2number,false)
   }

   _removescout() {
         C.displayelem(this.$.scout1, false)
         C.showeleme(this.$.scout1number,false)
         C.displayelem(this.$.scout1, false)
         C.showeleme(this.$.scout1number,false)
         C.displayelem(this.$.scout2, false)
         C.showeleme(this.$.scout2number,false)
         C.displayelem(this.$.scout2, false)
         C.showeleme(this.$.scout2number,false)
   }

   _removeterrain() {
       for (var i=0; i<this.terrains.length; i++)
           C.removeattr(this,this.terrains[i])
       C.showeleme(this.$.trade,false)
       C.showeleme(this.$.prod1,false)
       C.showeleme(this.$.prod2,false)
       C.showeleme(this.$.iron,false)
       C.showeleme(this.$.wheat,false)
       C.showeleme(this.$.incense,false)
       C.showeleme(this.$.silk,false)
       C.showeleme(this.$.coin,false)
       C.showeleme(this.$.hut,false)
       C.showeleme(this.$.village,false)
   }

   _clearsquare() {        
        C.displayelem(this.$.attcity,false)
        this._removearmy()
        this._removescout()
        this._removeterrain()
    }
   
   highlight(hightlight) {
	   if (hightlight) this.setAttribute("glowing",1) 
	   else C.removeattr(this,"glowing")
   }
   
   _clearhv() {
       C.showeleme(this.$.village,false)
       C.showeleme(this.$.hut,false)
       C.removeattr(this,"hut")	   
       C.removeattr(this,"village")       
   }

   refresh(jsdata) {

         if (jsdata == null) {
             this._clearsquare()
             return
           }
         const j = jsdata
         if (j.city != null) {
            this._removeterrain()
            C.displayelem(this.$.attcity,true)
            C.setColorForCity(this,j.city,C.colorForCiv(j.civ))
            this.setAttribute(j.city,1);
            C.displaybadge(this.$.prodcitynumber,j.production)
            C.displaybadge(this.$.defencecitynumber,"+"+j.defence)
            return;
         }
         if (j.terrain == null) return
         if (j.hv != null) {
        	 this.setAttribute(j.hv,1)
             if (j.hv == "Hut") C.showeleme(this.$.hut,true)
             if (j.hv == "Village") C.showeleme(this.$.village,true)
             return
         }
         this._clearhv()
         // show terrain 
         this.setAttribute(j.terrain,1)
         if (j.production >= 1) C.showeleme(this.$.prod1,true)
         if (j.production >= 2) C.showeleme(this.$.prod2,true)
         if (j.trade >= 1) C.showeleme(this.$.trade,true)
         if (j.resource == "Iron") C.showeleme(this.$.iron,true)
         if (j.resource == "Wheat") C.showeleme(this.$.wheat,true)
         if (j.resource == "Incense") C.showeleme(this.$.incense,true)
         if (j.resource == "Silk") C.showeleme(this.$.silk,true)
         if (j.resource == "Coin") C.showeleme(this.$.coin,true)
//         if (j.hv == "Hut") C.showeleme(this.$.hut,true)
 //        if (j.hv == "Village") C.showeleme(this.$.village,true)
         if (j.numberofArmies > 0) {
             if (C.civtonumb(j.civ) == 0) {
               C.displayelem(this.$.army1, true)
               C.displaybadge(this.$.army1number,j.numberofArmies)
             }
             else {
                 C.displayelem(this.$.army2, true)
                 C.displaybadge(this.$.army2number,j.numberofArmies)
             }
         }
         else this._removearmy()

         if (j.numberofScouts > 0) {
             if (C.civtonumb(j.civ) == 0) {
               C.displayelem(this.$.scout1, true)
               if (j.numberofScouts > 1) C.displaybadge(this.$.scout1number,j.numberofScouts)
             }
             else {
                 C.displayelem(this.$.scout2, true)
                 if (j.numberofScouts > 1) C.displaybadge(this.$.scout2number,j.numberofScouts)
             }
         }
         else this._removescout()
    }

  }

  // Register the x-custom element with the browser
  customElements.define(CivSquare.is, CivSquare);
</script>

</dom-module>
