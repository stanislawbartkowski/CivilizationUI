<dom-module id="civ-player"> 

<template>

<style>

  .undobuttons {
    position: relative;
    margin: 0;
    @apply --layout-horizontal;
/*    @apply --layout-end-justified; */ 
  }
  
  .undo {
    width: 15px;
  }

  .civname {
    border-radius: 15px;
    width: 90%;
    height: 30px; 
    text-align: center;
    font-size: 150%;
    padding-top: 5px;
    background-color : white;
    margin-left: 5px;
  }
    
  paper-icon-item {
     --paper-item-min-height : 0;
     --paper-item : {
       padding-top: 5px;
       padding-right: 8px;
       padding-bottom: 5px;
       padding-left: 8px;       
       }
  }

  paper-item {
     --paper-item-min-height : 0;
     --paper-item : {
       padding-top: 2px;
       padding-right: 5px;
       padding-bottom: 2px;
       padding-left: 8px;       
       }
  }
  
  .actionbox {
     margin-left: 5px;
     margin-top: 2px;
     border:1px ridge gray ; 
     display: block; 
     border-radius: 5px;
     width: 90%;
  }

  .unitbox {
     margin-left: 5px;
     margin-top: 2px;
     border:1px ridge gray ; 
     display: block; 
     border-radius: 5px;
     width: 90%;
  }

  .resourcebox {
     margin-left: 5px;
     margin-top: 2px;
     border:1px ridge gray ; 
     display: block; 
     border-radius: 5px;
     width: 90%;
  }
    
  #startofturn  {
  }

  #trade  {
  }

  #citymanagement  {   
  }

  #movement  {   
  }
  
  #research  {   
  }  
       
</style>
	
<div class="civname">[[civname]]</div>

<civ-playerstate id="playerstate"></civ-playerstate>

<span id="unitbox" class="unitbox" >
  <civ-units id="infantry"></civ-units>
  <civ-units id="artillery"></civ-units>
  <civ-units id="mounted"></civ-units>
  <civ-units id="aircraft"></civ-units>
</span>

<civ-resources id="resourcespanel" class="resourcebox"> </civ-resources>


<paper-item>
  <div>[[currentcommand]]</div>
 </paper-item>

 <paper-icon-item id="endofphase" on-click="_onClick">
  <iron-icon icon="done" slot="item-icon"></iron-icon> <span>{{localize('endofphase')}}</span>
 </paper-icon-item>

<span id="startofturn" class="actionbox">
 
	<paper-icon-item id="setcapital" on-click="_onClick">
        <iron-icon src="images/cities/capital.svg" slot="item-icon"></iron-icon> 
        <span>{{localize('capital')}}</span>
	</paper-icon-item>
	
	<paper-icon-item id="setcity" on-click="_onClick"> 
	   <iron-icon src="images/cities/city.svg" slot="item-icon"></iron-icon> 
	   <span>{{localize('setcity')}}</span>
	</paper-icon-item>
	
	<paper-icon-item id="setarmy" on-click="_onClick">
	  <iron-icon src="images/figures/army.svg"  slot="item-icon"></iron-icon> 
	  <span>{{localize('deployarmy')}}</span>
    </paper-icon-item>
		
	<paper-icon-item id="setscout" on-click="_onClick"> 
	  <iron-icon src="images/figures/scout.svg"  slot="item-icon"></iron-icon> 
	  <span>{{localize('deployscout')}}</span> 
   </paper-icon-item>
</span>

<span id="trade" class="actionbox" style="display:none">
</span>

<span id="citymanagement" class="actionbox" style="display:none">

<paper-menu-button> 

    <paper-icon-item id="unitmenu" slot="dropdown-trigger">
      <iron-icon icon="menu" slot="item-icon"></iron-icon>       
      <span>{{localize('units')}}</span>
    </paper-icon-item>

    <paper-tabs  slot="dropdown-content" class="dropdown-content">
        <paper-item id="buyinfantry" on-click="_onClick">{{localize('buyinfantry')}}</paper-item>
        <paper-item id="buymounted" on-click="_onClick">{{localize('buymounted')}}</paper-item>
        <paper-item id="buyartillery" on-click="_onClick">{{localize('buyartillery')}}</paper-item>
        <paper-item id="buyaircraft" on-click="_onClick">{{localize('buyaircraft')}}</paper-item>
    </paper-tabs>
</paper-menu-button>		
		
	<paper-icon-item id="buyarmy" on-click="_onClick"> 
	  <iron-icon src="images/figures/army.svg" slot="item-icon"></iron-icon> 
	  <span>{{localize('purchasearmy')}}</span> 
	</paper-icon-item>
	
	<paper-icon-item id="buyscout" on-click="_onClick"> 
	  <iron-icon src="images/figures/scout.svg" slot="item-icon"></iron-icon> 
	  <span>{{localize('purchasescout')}}</span>
    </paper-icon-item>

    <paper-icon-item id="harvestresource" on-click="_onClick"> 
      <iron-icon icon="icons:build" slot="item-icon"></iron-icon> 
      <span>{{localize('harvestresource')}}</span>
    </paper-icon-item>
    
    <div class="undobuttons">
            
      <paper-icon-item id="sendproduction" on-click="_onClick"> 
        <iron-icon src="images/tokens/production.svg" slot="item-icon"></iron-icon> 
        {{localize('sendproduction')}}
      </paper-icon-item>
      
      <paper-icon-item class="undo" id="undosendproduction" on-click="_onClick" title="{{localize('undosendproduction')}}">
       <iron-icon icon="icons:undo" slot="item-icon"></iron-icon> 
      </paper-icon-item>
      
    </div>
    
    <div class="undobuttons">
        
      <paper-icon-item id="spendtrade" on-click="_onClick"> 
        <iron-icon src="images/tokens/trade.svg" slot="item-icon"></iron-icon>        
         {{localize('spendtrade')}}
      </paper-icon-item>
        
      <paper-icon-item class="undo" id="undospendtrade" on-click="_onClick" title="{{localize('undospendtrade')}}"> 
          <iron-icon icon="icons:undo" slot="item-icon"></iron-icon> 
      </paper-icon-item>
      
    </div>
    
</span>
     

<span id="movement" class="actionbox" style="display:none">     
	
	<paper-icon-item id="startmove" on-click="_onClick">
	<iron-icon icon="fingerprint" slot="item-icon"></iron-icon> <span>{{localize('startmove')}}</span> 
	</paper-icon-item>
	
	<paper-icon-item id="move" on-click="_onClick"> <iron-icon
		icon="rowing" slot="item-icon"></iron-icon> <span>{{localize('continuemove')}}</span>
	</paper-icon-item>
	
	<paper-icon-item id="revealtile" on-click="_onClick">
	<iron-icon icon="lock-open" slot="item-icon"></iron-icon> <span>{{localize('revealtile')}}</span> 
	</paper-icon-item>
	
	<paper-icon-item id="explorehut" on-click="_onClick"> 
      <iron-icon src="images/huts/hut.svg" slot="item-icon"></iron-icon> 
      <span>{{localize('explorehut')}}</span>
    </paper-icon-item>
	
	
	<paper-icon-item id="endofmove" on-click="_onClick">
	   <iron-icon icon="pan-tool" slot="item-icon"></iron-icon> 
	   <span>{{localize('endofmove')}}</span> 
	 </paper-icon-item>

    <paper-icon-item id="attack" on-click="_onClick">
       <iron-icon src="images/icons/attack.svg" slot="item-icon"></iron-icon> 
       <span>{{localize('attack')}}</span> 
     </paper-icon-item>
	 	
</span>		

<span id="research" class="actionbox" style="display:none">     
    <paper-icon-item id="research" on-click="_onClick">
      <iron-icon src="images/cities/research.svg" slot="item-icon"></iron-icon> 
       <span>{{localize('researchlabel')}}</span> 
     </paper-icon-item>
</span>		
</template> 

<script>
      
class CivPlayer extends Polymer.CivData(Polymer.GestureEventListeners(Polymer.Element)) {
      
	static get is() { return 'civ-player' }

    static get properties() {
		
		return {
                               
              civname: {
                  type: String,
                   value: undefined
               },
               currentcommand : {
                    type : String,
                    value : undefined
                },
                itemizedcommand : {
                    type : Object,
                    value : undefined,
                    observer: '_itemized'
                },
                figurecolor1 : {
                    type: String,
                    value: function() { return C.color1(); }
                },
                
                listofpoints : {
                	type : Array,
                	value : null
                },
                
                opponent : {
                	type : Boolean
                },

                y : {
                    type : Object
                },

                actionpanels : {
                	type : Array,
                    readOnly: true,
                	value :
                    [
                         "startofturn",
                         "trade",
                         "citymanagement",
                         "movement",        
                         "research"
                    ]
                },
                
               unitsmenu : {
                   type : Array,
                   readOnly: true,
                   value : [                   
                            "buymounted",
                            "buyartillery",
                            "buyinfantry",
                            "buyaircraft"
                  ]            	   
               },
                 
               buttons : {
            	   type : Array,
                   readOnly: true,
            	   value : [            	   
                            "setcapital",
                            "endofphase",
                            "setarmy",
                            "setscout",        
                            "buyarmy",
                            "buyscout",
                            "startmove",
                            "move",
                            "revealtile",
                            "endofmove",
                            "setcity",
                            "spendtrade",
                            "undospendtrade",
                            "sendproduction",
                            "undosendproduction",
                            "buymounted",
                            "buyartillery",
                            "buyinfantry",
                            "buyaircraft",
                            "harvestresource",
                            "explorehut",
                            "attack"
                  ]
             }
	   }
    }
    
    setListOfPoints(a) {
        C.highlightGame(this.listofpoints,false);
        C.highlightGame(a,true);
        this.listofpoints = a;    	
    }
            
    _itemized(newValue,oldValue) {
    	const a = C.getlistofpoints(this.currentcommand,newValue);
    	this.setListOfPoints(a)
    	if (a != null) C.checkAutomateButton()
    }
                 
    _callitemize(id) {
       this.currentcommand = id
       window.itemizecommand(id.toUpperCase())    	
    }
    
    _actionname(id) {
        var name = C.localize(id)
        if (name == null || name == "") {
        	if (id == "buyarmy") name = C.localize("purchasearmy")
        	else
        	if (id == "buyscout") name = C.localize("purchasescout")
        	else
        		name = id
        }
        return name
    }
            
    _endofphase() {
        this.currentcommand = null
        const g = C.getjsboard().board.game
        const phase = g.phase
    	const y = this.y
    	// do not ask if no more commands
    	if (y.commands.length == 1) {
    		C.executeEndOfPhase()
    		return
    	}
    	var actions = null
        for (var i=0; i<y.commands.length; i++) {
            const command = y.commands[i]
            const id = command.command.toLowerCase()
            if (id == "endofphase") continue
            var name = this._actionname(id)
            if (actions == null) actions = name
            else actions = actions + ", " + name
        }            
        const labelphase = C.getphasedescr(phase)
        C.confexecutedialog(this.localize("doyouwantendquestion","phase",labelphase,"actions",actions),"endofphase",-1,-1,phase)
    }
        
    _onClick(source) {
    	     if (this.opponent) return
    	     if (C.issendproductionscout()) {
    	    	 C.alertdialog(C.localize('specifythesuqretoharvest') + " !")
    	    	 return
    	     }    	     
             var id = source.currentTarget.id
             if (id == "endofphase") {
                 this._endofphase()
            	 return
             }
            if (id == "endofmove") {
               this.currentcommand = null
               C.confexecutedialog(this.localize("doyouwantfinishmovequestion"),id,-1,-1,null)
               return
            }
            if (id == "research") {
            	C.researchdialog(this.y)
            	return
            }            
           this._callitemize(id) 
         }
    
     
         clear() {
             this.itemizedcommand = null;
             this.listofpoints = null;
             this.currentcommand = null;        
         }
         
         clearCommand() {
        	 this.clear()
         }
         
         _youactive() {
        	 if (this.opponent) return false
        	 const y = this.y
             const g = this.data.board.game
             return y.civ == g.active
         }
                           
         refresh(b) {
        	   if (b == null) {
        		   this.clear()
                   const respanel = this.$.resourcespanel
                   respanel.draw(null)
                   respanel.draw1(null)
        		   return;
        	   }
        	   var y
        	   if (this.opponent) y = b.board.others[0]
        	   else y = b.board.you
        	   this.y = y
               C.setColorForCity(this,"civname",C.backcolorForCiv(y.civ))
               this.civname=y.civ
               // player status
               const yp = this.$.playerstate
               yp.draw(y)
               
               const g = b.board.game
               const pha = g.phase.toLowerCase()
               for (var i=0; i < this.actionpanels.length; i++) {
                   const id = this.actionpanels[i]
                   const pa = this.shadowRoot.getElementById(id);
                   if (id == pha) C.displayelem(pa,true)
                   else C.displayelem(pa,false)
                }

               
               for (var i=0; i < this.buttons.length; i++) {
                  const id = this.buttons[i]
                  const bu = this.shadowRoot.getElementById(id);
                  C.disableleme(bu,true)
               }
              var disableu = true
              for (var i=0; i<y.commands.length; i++) {
                  const command = y.commands[i]
                  const id = command.command.toLowerCase()
                  const bu = this.shadowRoot.getElementById(id);
                  C.disableleme(bu,false)
                  if (this._youactive())
                    if (!this.opponent && id == "move" 
                	  	  && this.currentcommand != "revealtile" 
                		  && this.currentcommand != "explorehut" 
                		  && this.currentcommand != "attack") 
                	  this._callitemize(id)
                 // check units menu
                 for (var j=0; j< this.unitsmenu.length; j++)
                	 if (this.unitsmenu[j] == id) disableu = false                 
              }
              const u = this.$.unitmenu
              C.disableleme(u,disableu)
              C.setUnitsNumb(this,y.units)
              const respanel = this.$.resourcespanel
              const r = y.resources
              respanel.draw(r)
              const h = y.hutvillages
              respanel.draw1(h)
              if (this._youactive()) {
            	  var s = null
            	  for (var i=0; i<y.commands.length; i++)
            		  if (s == null) s = y.commands[i].command
            		  else s = s + "," + y.commands[i].command
                  C.log("player:"+ g.active + " " + g.phase + " " + s)                  
            	  C.automateCommand(y.commands)
              }              
           }
        }
        
window.customElements.define(CivPlayer.is, CivPlayer);
        
        
</script> 

</dom-module>